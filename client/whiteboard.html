<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		
		<script src="/jquery-1.5.1.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="/nowjs/now.js" type="text/javascript" charset="utf-8"></script>
		<script src="/coffee-script.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/coffeescript">
			$(window).load ->
				ctx = null
				first_point = true
				draw = false
				draw_queue = []
				
				setup_canvas = ->
					draw = false
					canvas = $('canvas#board')[0]
				
					ctx = canvas.getContext '2d'
					ctx.strokeStyle = 'black'
					ctx.lineWidth = 5
					ctx.lineCap = 'round'
				
					$('canvas#board').mousedown ->
						draw = true
				
					$('canvas#board').mouseup ->
						draw = false
						first_point = true
				
					$('canvas#board').mousemove (e) ->
						draw_queue.push [e.pageX, e.pageY] if draw
				
				eval_draw_queue = ->
					return if draw_queue.length is 0
					
					next = draw_queue.shift()
					
					if first_point
						ctx.moveTo next[0] - 1, next[1] - 1
						first_point = false
					
					ctx.lineTo next[0], next[1]
					ctx.stroke()
				
					now.distribute_draw next[0], next[1]
				
				now.receive_draw = (x, y) ->
					if first_point
						ctx.moveTo x - 1, y - 1
						first_point = false
					
					ctx.lineTo x, y
					ctx.stroke()
				now.receive_identify = (name) ->
					console.log "sdfsdf #{name}"
					$('#players').append "<li>#{name}</li>"
				
				# Time to go
				setup_canvas()
				
				# Start the queue eval interval
				setInterval eval_draw_queue, 10
				
				#now.distribute_identify prompt('Name?', '')
		</script>
		
		<style type="text/css" media="screen">
			canvas#board {
				cursor: crosshair;
				border: 1px solid black;
			}
		</style>
		
		<title>chat</title>
	</head>
	<body>
		<canvas id="board" width="800" height="500"></canvas>
		<ul id="players">
			
		</ul>
	</body>
</html>
